<th:block xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:fragment="header">
	<script
		src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
	<!-- 	ë§ˆì´í˜ì´ì§€ cssì…ë‹ˆë‹¤ -->
	<link rel="stylesheet" th:href="@{/css/emp/emp_main.css}">
	<div class="costom-inner">
		<nav
			class="costom-nav layout-navbar container-xxl navbar-detached navbar navbar-expand-xl align-items-center bg-navbar-theme"
			id="layout-navbar">
			<div
				class="layout-menu-toggle navbar-nav align-items-xl-center me-4 me-xl-0 d-xl-none">
				<a class="nav-item nav-link px-0 me-xl-6" href="javascript:void(0)">
					<i class="icon-base bx bx-menu icon-md"></i>
				</a>
			</div>

			<div
				class="navbar-nav-right d-flex align-items-center justify-content-end"
				id="navbar-collapse">

				<ul class="navbar-nav flex-row align-items-center ms-md-auto">
					<!-- ë©”ì‹ ì € -->
					<li class="me-4"><a class="dropdown-item" href="#"
						onclick="openMessengerPopup(event)"> <span
							class="d-flex align-items-center align-middle position-relative">
								<i class="tf-icons bx bx-message-rounded"
								style="font-size: 1.6rem;"></i> <span id="chat-badge"
								class="badgerounded-pill bg-danger position-absolute text-white d-flex justify-content-center align-items-center"
								style="font-size: 0.6rem; min-width: 1rem; height: 1rem; top: 75%; right: 51px; transform: translate(50%, -50%); border-radius: 50%;">
							</span> <span class="flex-grow-1 align-middle ms-2">ë©”ì‹ ì €</span>
						</span>
					</a></li>

					<!-- User -->
					<li class="nav-item navbar-dropdown dropdown-user dropdown"><a
						class="nav-link dropdown-toggle hide-arrow p-0"
						href="javascript:void(0);" data-bs-toggle="dropdown">
							<div class="avatar avatar-online">
								<img th:src="@{/assets/img/avatars/1.png}" alt
									class="w-px-40 h-auto rounded-circle" />
							</div>
					</a>
						<ul class="dropdown-menu dropdown-menu-end">
							<li><a class="dropdown-item" href="#">
									<div class="d-flex">
										<div class="flex-shrink-0 me-3">
											<div class="avatar avatar-online">
												<img th:src="@{/assets/img/avatars/1.png}" alt
													class="w-px-40 h-auto rounded-circle" />
											</div>
										</div>
										<div class="flex-grow-1">
											<h6 class="mb-0">John Doe</h6>
											<small class="text-body-secondary">Admin</small>
										</div>
									</div>
							</a></li>
							<li>
								<div class="dropdown-divider my-1"></div>
							</li>
							<li><a class="dropdown-item" href="#"
								onclick="openMypagePopup(event)"> <i
									class="icon-base bx bx-user icon-md me-3"></i><span>ë§ˆì´í˜ì´ì§€</span>
							</a></li>
							<li>
								<div class="dropdown-divider my-1"></div>
							</li>
							<li><a href="#" class="dropdown-item"
								onclick="event.preventDefault(); document.getElementById('logoutForm').submit();">
									<i class="icon-base bx bx-power-off icon-md me-3"></i><span>ë¡œê·¸ì•„ì›ƒ</span>
							</a></li>
							<form id="logoutForm" action="/SOLEX/logout" method="post"
								style="display: none;"></form>
						</ul></li>
					<!--/ User -->
				</ul>
			</div>
		</nav>
	</div>

	<!-- âœ¨ Mypage ëª¨ë‹¬ì°½ ë„ìš°ê¸° ìœ„í•´  -->
	<div class="modal fade" id="mypageModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable modal-xl">
			<div class="modal-content">
				<div class="modal-header border-0 pb-1">
					<h3 class="modal-title fw-semibold" id="exampleModalLabel">ë§ˆì´í˜ì´ì§€</h3>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<!-- JSì—ì„œ ì´ ë¶€ë¶„ì„ ì±„ì›€ -->
				<div class="modal-body pt-0">
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
					<button type="submit" class="btn btn-primary" id="mypageModifyBtn">ìˆ˜ì •</button>
				</div>
			</div>
		</div>
	</div>

	<script>
		function openMessengerPopup(event) {
			event.preventDefault();
			const popup = window.open('/SOLEX/chats', 'MessengerWindow', 'width=500,height=700,left=100,top=100');
			if (!popup || popup.closed) {
				alert('íŒì—… ì°¨ë‹¨ í•´ì œí•´ì£¼ì„¸ìš”!');
			} else {
				popup.focus();
			}
		}
	
		function unreadCnt() {
			$.ajax({
				url: '/SOLEX/chats/unreadCount',
				method: 'GET',
				success: function(count) {
					const badge = document.getElementById('chat-badge');
					if (!badge) return;
					if (count > 0) {
						badge.textContent = count;
						badge.classList.remove('d-none');
					} else {
						badge.classList.add('d-none');
					}
				},
				error: function() {
					console.error('ì•ˆì½ì€ ë©”ì‹œì§€ ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
				}
			});
		}
		document.addEventListener('DOMContentLoaded', function () {
			unreadCnt();
		});
		
		// "ë§ˆì´í˜ì´ì§€" ë©”ë‰´ í´ë¦­ ì‹œ ì‹¤í–‰
		async function openMypagePopup(event) {
			event.preventDefault();
			
			try {
				const response = await fetch(`/SOLEX/mypage/empData`);
				if (!response.ok) throw new Error('ì‚¬ì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
				const empData = await response.json();
				openModalWithData(empData);
			} catch (error) {
				console.error(error);
				alert(error.message);
			}
		}
		
		// ë§ˆì´í˜ì´ì§€ ëª¨ë‹¬ì°½ì„ ë°ì´í„°ë¡œ ì±„ìš°ê³  ë³´ì—¬ì£¼ëŠ” í•¨ìˆ˜
		function openModalWithData(empData){
			
			const modalElement = document.getElementById('mypageModal');
			if (!modalElement) return;

			const modal = new bootstrap.Modal(modalElement);
			const modalBody = modalElement.querySelector('.modal-body');
			modalBody.innerHTML = ''; // ì´ì „ ë‚´ìš© ì´ˆê¸°í™”
			
			const {
			 	empNm, empPc, empAdd, empDa, empEmail, empPhone,
			 	empHire, empBirth, empGd,
			 	EMPPOSCD, EMPCATCD, EMPDEPCD, EMPTEAMCD, empProfileImg // ğŸ“¸ í”„ë¡œí•„ ì´ë¯¸ì§€ ê²½ë¡œ ì¶”ê°€
			} = empData;
				  
			// í•¸ë“œí°Â·ì´ë©”ì¼ ë¶„ë¦¬
			const [hp1 = '', hp2 = '', hp3 = ''] = empPhone ? empPhone.split('-') : [];
			const [em1 = '', em2 = ''] = empEmail ? empEmail.split('@') : [];
			
			// âœ… ìˆ˜ì •: empProfileImgê°€ ìˆì„ ë•Œë§Œ ê²½ë¡œë¥¼ ë§Œë“¤ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
			const profileImgSrc = empProfileImg 
                ? `/SOLEX/uploads/${empProfileImg}` 
                : '/SOLEX/assets/img/emp/simple_person_pic.jpg';

			// ëª¨ë‹¬ ë°”ë””ì— ë“¤ì–´ê°ˆ Form HTML ìƒì„±
			const formHTML = `
				<form id="mypageForm" onsubmit="return false;">
					<div class="container-fluid">
						<div class="row g-4">
							<div class="col-md-4 text-center">
								<label class="form-label fw-semibold">ì‚¬ì§„</label>
								<img id="emp_img_preview" src="${profileImgSrc}"
										class="w-100 rounded shadow-sm mb-3" style="aspect-ratio:4/5;object-fit:cover;" />
								<input type="file" class="form-control" name="emp_img" id="emp_img" accept="image/*">
							</div>
							
							<div class="col-md-8">
								<div class="row g-3">
									<div class="col-md-6">
										<label for="empNm" class="form-label">ì´ë¦„</label>
										<input type="text" class="form-control" id="empNm" name="emp_nm" value="${empNm || ''}" required>
									</div>
									<div class="col-md-6">
										<label for="empHire" class="form-label">ì…ì‚¬ì¼</label>
										<input type="text" class="form-control" id="empHire" name="emp_hire" value="${empHire || ''}" readonly>
									</div>
									
									<div class="col-md-6 d-flex align-items-end">
										<div class="me-3">
											<label class="form-label d-block mb-1">ì„±ë³„</label>
											<div class="btn-group" role="group" aria-label="gender switcher">
												<input type="radio" class="btn-check" name="emp_gd" id="genderM" value="M" ${empGd === 'M' ? 'checked' : ''} disabled>
												<label class="btn btn-outline-primary" for="genderM">ë‚¨</label>
												<input type="radio" class="btn-check" name="emp_gd" id="genderW" value="W" ${empGd === 'W' ? 'checked' : ''} disabled>
												<label class="btn btn-outline-primary" for="genderW">ì—¬</label>
											</div>
										</div>
									</div>
									<div class="col-md-6">
										<label for="emp_birth" class="form-label">ìƒë…„ì›”ì¼</label>
										<input type="text" class="form-control" name="emp_birth" id="emp_birth" value="${empBirth || ''}" readonly>
									</div>
									
									<div class="col-12">
										<label class="form-label">ì—°ë½ì²˜</label>
										<div class="input-group">
											<input type="text" id="emp_phone1" class="form-control" value="${hp1}" placeholder="010" required>
											<span class="input-group-text">-</span>
											<input type="text" id="emp_phone2" class="form-control" value="${hp2}" placeholder="1234" required>
											<span class="input-group-text">-</span>
											<input type="text" id="emp_phone3" class="form-control" value="${hp3}" placeholder="5678" required>
										</div>
										<input type="hidden" name="emp_phone" id="emp_phone">
									</div>
	
									<div class="col-12">
										<label class="form-label">ì´ë©”ì¼</label>
										<div class="input-group">
											<input type="text" id="emp_email1" class="form-control" value="${em1}" placeholder="example" required>
											<span class="input-group-text">@</span>
											<input type="text" id="emp_email2" class="form-control" value="${em2}" placeholder="company.com" required>
										</div>
										<input type="hidden" name="emp_email" id="emp_email">
									</div>
	
									<div class="col-md-6">
										<label class="form-label">ì§ê¸‰</label>
										<input type="text" class="form-control" value="${EMPPOSCD}" readonly>
									</div>
									<div class="col-md-6">
										<label class="form-label">ì¢…ë¥˜</label>
										<input type="text" class="form-control" value="${EMPCATCD}" readonly>
									</div>
									<div class="col-md-6">
										<label class="form-label">ë¶€ì„œ</label>
										<input type="text" class="form-control" value="${EMPDEPCD}" readonly>
									</div>
									<div class="col-md-6">
										<label class="form-label">íŒ€</label>
										<input type="text" class="form-control" value="${EMPTEAMCD}" readonly>
									</div>
									
									<div class="col-12">
										<label class="form-label">ì£¼ì†Œ</label>
										<div class="input-group mb-2">
											<input type="text" id="sample6_postcode" name="emp_pc" class="form-control" placeholder="ìš°í¸ë²ˆí˜¸" value="${empPc || ''}" required>
											<button type="button" class="btn btn-outline-secondary" onclick="sample6_execDaumPostcode()">ìš°í¸ë²ˆí˜¸ ì°¾ê¸°</button>
										</div>
										<input type="text" id="sample6_address" name="emp_add" class="form-control mb-2" placeholder="ì£¼ì†Œ" value="${empAdd || ''}" required>
										<input type="text" id="sample6_detailAddress" name="emp_da" class="form-control" placeholder="ìƒì„¸ì£¼ì†Œ" value="${empDa || ''}" required>
									</div>
								</div>
							</div>
						</div>
					</div>
				</form>
			`;
			modalBody.innerHTML = formHTML;
				
			// ğŸ“¸ ì‚¬ì§„ íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸ (ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©)
			modalBody.addEventListener('change', e => {
				if (e.target.id === 'emp_img') {
					const file = e.target.files[0];
					if (file) {
						const reader = new FileReader();
						reader.onload = evt => {
							document.getElementById('emp_img_preview').src = evt.target.result;
						};
						reader.readAsDataURL(file);
					}
				}
			});

			modal.show();
		}
		
		//í¼ ì œì¶œ ì „ ìœ íš¨ì„± ê²€ì‚¬!
		function validateForm() {
			
			
		    // 1. ì´ë¦„ ìœ íš¨ì„± ê²€ì‚¬ (2~4ì)
		    const empNm = document.getElementById('empNm');
			if(!empNm.value){
				alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
			} else if (empNm.value.length < 2 || empNm.value.length > 4) {
			    alert('ì´ë¦„ì€ ìµœì†Œ 2ìì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.');
			    empNm.focus();
			    return false;
			}

		    // 2. ì—°ë½ì²˜ ìœ íš¨ì„± ê²€ì‚¬ (010-xxxx-xxxx)
		    const empPhone1 = document.getElementById('emp_phone1');
		    const empPhone2 = document.getElementById('emp_phone2');
		    const empPhone3 = document.getElementById('emp_phone3');
		    const phonePattern = /^010-\d{4}-\d{4}$/;
		    const fullPhoneNumber = `${empPhone1.value}-${empPhone2.value}-${empPhone3.value}`;
			
			if(!fullPhoneNumber){
				alert('ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
			} else if (!phonePattern.test(fullPhoneNumber)) {
		        alert('ì—°ë½ì²˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
		        empPhone1.focus();
		        return false;
		    }
		   
		    // í•„ìˆ˜ ì…ë ¥ í•„ë“œ í™•ì¸ (ì…ì‚¬ì¼, ì´ë©”ì¼ ë“±)
		    const requiredFields = document.querySelectorAll('#empForm [required]');
		    for (const field of requiredFields) {
		        if (!field.value) {
		            // í•„ë“œì— ì—°ê²°ëœ label í…ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
		            const label = field.closest('.col-md-6, .col-12, .col-md-4')?.querySelector('label');
		            const fieldName = label ? label.innerText.replace('*', '').trim() : field.name || field.id;
		            alert(`'${fieldName}' ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
		            field.focus();
		            return false;
		        }
		    }

		    // ëª¨ë“  ê²€ì‚¬ë¥¼ í†µê³¼í•˜ë©´ true ë°˜í™˜
		    return true;
		}

		// "ìˆ˜ì •" ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
		document.getElementById('mypageModifyBtn').addEventListener('click', async () => {
			// 1. ì—°ë½ì²˜, ì´ë©”ì¼ ë³‘í•©
			const fullPhone = [
				document.getElementById('emp_phone1')?.value,
				document.getElementById('emp_phone2')?.value,
				document.getElementById('emp_phone3')?.value
			].join('-');
			
			const fullEmail = [
				document.getElementById('emp_email1')?.value,
				document.getElementById('emp_email2')?.value
			].join('@');

			// 2. ì„œë²„ì— ë³´ë‚¼ í…ìŠ¤íŠ¸ ë°ì´í„°(payload) ìƒì„±
			const payload = {
				empNm: document.getElementById('empNm').value,
				empPhone: fullPhone,
				empEmail: fullEmail,
				empPc: document.getElementById('sample6_postcode').value,
				empAdd: document.getElementById('sample6_address').value,
				empDa: document.getElementById('sample6_detailAddress').value
			};
			
            // 3. FormData ê°ì²´ ìƒì„± ë° í…ìŠ¤íŠ¸ ë°ì´í„° ì¶”ê°€
			const finalFormData = new FormData(); 
		    finalFormData.append(
		        'emp',
		        new Blob([JSON.stringify(payload)], { type: 'application/json' })
		    );

            // âœ… ìˆ˜ì •: ì‚¬ìš©ìê°€ ìƒˆë¡œ ì„ íƒí•œ íŒŒì¼ì´ ìˆì„ ê²½ìš°ì—ë§Œ FormDataì— ì¶”ê°€
            const fileInput = document.getElementById('emp_img');
            if (fileInput.files.length > 0) {
                finalFormData.append('emp_img', fileInput.files[0]);
            }
	
			// 4. ì„œë²„ë¡œ FormData ì „ì†¡
			
			if (validateForm()) {
				console.log('ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼!');
				
				try {
					const response = await fetch('/SOLEX/mypage/personalDataModify', {
						method: 'PUT',
						body: finalFormData
					});
	
					if (!response.ok) {
	                    const errorText = await response.text();
	                    throw new Error(`ìˆ˜ì • ì‹¤íŒ¨: ${errorText}`);
	                }
					
					alert(`ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
					bootstrap.Modal.getInstance(document.getElementById('mypageModal')).hide();
	
				} catch (error) {
					console.error('ìˆ˜ì • ì‹¤íŒ¨ !@!#@!#!', error);
					alert(error.message);
				}
			}
		});
		
		function sample6_execDaumPostcode() {	
		    new daum.Postcode({
		        oncomplete: function(data) {
		            var addr = '';
		            if (data.userSelectedType === 'R') {
		                addr = data.roadAddress;
		            } else {
		                addr = data.jibunAddress;
		            }
		            document.getElementById('sample6_postcode').value = data.zonecode;
		            document.getElementById("sample6_address").value = addr;
		            document.getElementById("sample6_detailAddress").focus();
		        }
		    }).open();
		}
	</script>
</th:block>