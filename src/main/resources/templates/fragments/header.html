<th:block xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:fragment="header">
	<script
		src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
	<!-- 	ÎßàÏù¥ÌéòÏù¥ÏßÄ cssÏûÖÎãàÎã§ -->
	<link rel="stylesheet" th:href="@{/css/emp/emp_main.css}">
	<div class="costom-inner">
		<nav
			class="costom-nav layout-navbar container-xxl navbar-detached navbar navbar-expand-xl align-items-center bg-navbar-theme"
			id="layout-navbar">
			<div
				class="layout-menu-toggle navbar-nav align-items-xl-center me-4 me-xl-0 d-xl-none">
				<a class="nav-item nav-link px-0 me-xl-6" href="javascript:void(0)">
					<i class="icon-base bx bx-menu icon-md"></i>
				</a>
			</div>

			<div
				class="navbar-nav-right d-flex align-items-center justify-content-end"
				id="navbar-collapse">

				<ul class="navbar-nav flex-row align-items-center ms-md-auto">
					<!-- Î©îÏã†Ï†Ä -->
					<li class="me-4"><a class="dropdown-item" href="#"
						onclick="openMessengerPopup(event)"> <span
							class="d-flex align-items-center align-middle position-relative">
								<i class="tf-icons bx bx-message-rounded"
								style="font-size: 1.6rem;"></i> <span id="chat-badge"
								class="badgerounded-pill bg-danger position-absolute text-white d-flex justify-content-center align-items-center"
								style="font-size: 0.6rem; min-width: 1rem; height: 1rem; top: 75%; right: 51px; transform: translate(50%, -50%); border-radius: 50%;">
							</span> <span class="flex-grow-1 align-middle ms-2">Î©îÏã†Ï†Ä</span>
						</span>
					</a></li>

					<!-- User -->
					<li class="nav-item navbar-dropdown dropdown-user dropdown"><a
						class="nav-link dropdown-toggle hide-arrow p-0"
						href="javascript:void(0);" data-bs-toggle="dropdown">
							<div class="avatar avatar-online">
								<img th:src="@{/assets/img/avatars/1.png}" alt
									class="w-px-40 h-auto rounded-circle" />
							</div>
					</a>
						<ul class="dropdown-menu dropdown-menu-end">
							<li><a class="dropdown-item" href="#">
									<div class="d-flex">
										<div class="flex-shrink-0 me-3">
											<div class="avatar avatar-online">
												<img th:src="@{/assets/img/avatars/1.png}" alt
													class="w-px-40 h-auto rounded-circle" />
											</div>
										</div>
										<div class="flex-grow-1">
											<h6 class="mb-0">John Doe</h6>
											<small class="text-body-secondary">Admin</small>
										</div>
									</div>
							</a></li>
							<li>
								<div class="dropdown-divider my-1"></div>
							</li>
							<li><a class="dropdown-item" href="#"
								onclick="openMypagePopup(event)"> <i
									class="icon-base bx bx-user icon-md me-3"></i><span>ÎßàÏù¥ÌéòÏù¥ÏßÄ</span>
							</a></li>
							<li>
								<div class="dropdown-divider my-1"></div>
							</li>
							<li><a href="#" class="dropdown-item"
								onclick="event.preventDefault(); document.getElementById('logoutForm').submit();">
									<i class="icon-base bx bx-power-off icon-md me-3"></i><span>Î°úÍ∑∏ÏïÑÏõÉ</span>
							</a></li>
							<form id="logoutForm" action="/SOLEX/logout" method="post"
								style="display: none;"></form>
						</ul></li>
					<!--/ User -->
				</ul>
			</div>
		</nav>
	</div>

	<!-- ‚ú® Mypage Î™®Îã¨Ï∞Ω ÎùÑÏö∞Í∏∞ ÏúÑÌï¥  -->
	<div class="modal fade" id="mypageModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-scrollable modal-xl">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLabel">ÎßàÏù¥ÌéòÏù¥ÏßÄ</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<!-- JSÏóêÏÑú Ïù¥ Î∂ÄÎ∂ÑÏùÑ Ï±ÑÏõÄ -->
				<div class="modal-body"></div>
			</div>
		</div>
	</div>

	<script>
		function openMessengerPopup(event) {
			event.preventDefault();
			const popup = window.open('/SOLEX/chats', 'MessengerWindow', 'width=500,height=700,left=100,top=100');
			if (!popup || popup.closed) {
				alert('ÌåùÏóÖ Ï∞®Îã® Ìï¥Ï†úÌï¥Ï£ºÏÑ∏Ïöî!');
			} else {
				popup.focus();
			}
		}
	
		function unreadCnt() {
			$.ajax({
				url: '/SOLEX/chats/unreadCount',
				method: 'GET',
				success: function(count) {
					const badge = document.getElementById('chat-badge');
					if (!badge) return;
					if (count > 0) {
						badge.textContent = count;
						badge.classList.remove('d-none');
					} else {
						badge.classList.add('d-none');
					}
				},
				error: function() {
					console.error('ÏïàÏùΩÏùÄ Î©îÏãúÏßÄ Ïàò Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®');
				}
			});
		}
		document.addEventListener('DOMContentLoaded', function () {
			unreadCnt();
		});
		//ÎßàÏù¥ÌéòÏù¥ÏßÄ ÎàÑÎ•¥Î©¥ Î°úÍ∑∏Ïù∏ Ìïú ÏÇ¨ÏõêÏùò ÎßàÏù¥ÌéòÏù¥ÏßÄ Î™®Îã¨ Ïó¥Î¶¨Í≤å 
		async function openMypagePopup(event) {
			event.preventDefault();
			
			const response = await fetch(`/SOLEX/mypage/empData`);
			const empData = await response.json();
			openModal(empData);
		}
		
		//ÎßàÏù¥ÌéòÏù¥ÏßÄ Î™®Îã¨Ï∞Ω ÎÇ¥Î∂Ä
		async function openModal(empData){
			
			const modalElement = document.getElementById('mypageModal');
			const modal = new bootstrap.Modal(modalElement);
			const modalBody = modalElement.querySelector('.modal-body');
			modalBody.innerHTML = '';
			
			// 2Ô∏è‚É£ Îß§Ìïë Ìï®Ïàò: ÏΩîÎìúÍ∞Ä ÏóÜÍ±∞ÎÇò Îß§ÌïëÏù¥ Ïïà Îèº ÏûàÏúºÎ©¥ ÏõêÎ≥∏ Í∑∏ÎåÄÎ°ú Î¶¨ÌÑ¥
			const labelOf = (codeKey, codeValue) => CODE_LABEL[codeKey]?.[codeValue] ?? codeValue;
			
			// Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄ Í≤ΩÎ°ú
			const defaultImg = '/assets/img/emp/simple_person_pic.jpg';
			
			const {
			 	empNm      = '',
			 	empPc      = '',
			 	empAdd     = '',
			    empDa      = '',
			    empEmail   = '',
			    empPhone   = '',
			    empHire    = '',
			    empBirth   = '',
			    empGd      = '',
			    EMPPOSCD   = '',
			    EMPCATCD   = '',
			    EMPDEPCD   = '',
			    EMPTEAMCD  = '',
			    empImg: empImgUrl = ''
			} = empData;
			
			
			// Ìï∏ÎìúÌè∞¬∑Ïù¥Î©îÏùº Î∂ÑÎ¶¨(ÌïÑÏöîÌïòÎ©¥)
			const [hp1 = '', hp2 = '', hp3 = ''] = empPhone.split('-');
			const [em1 = '', em2 = '']           = empEmail.split('@');	  
				  
			const form = document.createElement('form');
			form.id = 'mypageForm';
			form.innerHTML = `
				<div class="row mb-4">
				  <div class="col-3">
				    <label>ÏÇ¨ÏßÑ</label>
				    <img id="emp_img_preview" alt="ÏÇ¨ÏßÑ ÎØ∏Î¶¨Î≥¥Í∏∞"
				    	src="${empImgUrl ? empImgUrl : defaultImg}" //Ïù¥ÎØ∏ÏßÄ ÏóÜÏùÑÎïê Í∏∞Î≥∏Ïù¥ÎØ∏ÏßÄ, Ïô∏ÏóêÎäî ÏßÄÍ∞Ä ÏÑ§Ï†ïÌïú Ïù¥ÎØ∏ÏßÄ 
				         style="width:173px; height:208px; border-radius:4px; object-fit:cover; display:block; margin-bottom:10px;" />
				    <input type="file" class="form-control" name="emp_img" id="emp_img" accept="image/*" required>
				  </div>
	
				  <!-- üßæ Ïò§Î•∏Ï™Ω: ÎÇòÎ®∏ÏßÄ ÏûÖÎ†• Ìèº -->
				  <div class="col-9">
				    <div class="row mb-3">
				      <div class="col">
				        <label>Ïù¥Î¶Ñ</label>
				        <input type="text" class="form-control" name="emp_nm" value="${empNm}" required>
				      </div>
				      <div class="col">
				        <label>ÏûÖÏÇ¨Ïùº</label>
				        <input type="date" class="form-control" name="emp_hire" value="${empHire}" readonly>
				      </div>
				    </div>
	
				    <div class="row mb-3">
				      <div class="col">
				        <label>ÏÑ±Î≥Ñ</label><br>
				        <label id="genderM"><input type="radio" name="emp_gd" value="M" checked> ÎÇ®</label>
				        <label><input type="radio" name="emp_gd" value="W"> Ïó¨</label>
				      </div>
				      <div class="col">
				        <label>ÏÉùÎÖÑÏõîÏùº</label>
				        <input type="text" class="form-control" name="emp_birth" id="emp_birth" pattern="\\d{6}" value="${empBirth}" placeholder="ex)990101" readonly>
				        <input type="hidden" name="emp_pw" id="emp_pw">
				      </div>
				    </div>
	
				    <div class="row mb-3">
				      <div class="col">
				        <label>Ïó∞ÎùΩÏ≤ò</label><br>
				        <input type="text" id="emp_phone1" class="form-control d-inline-block w-25" value="${hp1}" required> -
				        <input type="text" id="emp_phone2" class="form-control d-inline-block w-25" value="${hp2}" required> -
				        <input type="text" id="emp_phone3" class="form-control d-inline-block w-25" value="${hp3}" required>
				        <input type="hidden" name="emp_phone" id="emp_phone">
				      </div>
				    </div>
	
				    <div class="row mb-3">
				      <div class="col">
				        <label>Ïù¥Î©îÏùº</label><br>
				        <input type="text" id="emp_email1" class="form-control d-inline-block w-25" value="${em1}" required> @
				        <input type="text" id="emp_email2" class="form-control d-inline-block w-25" value="${em2}" required>
				        <input type="hidden" name="emp_email" id="emp_email">
				      </div>
				    </div>
	
				    <div class="row mb-3">
				      <div class="col">
				        <label>ÏßÅÍ∏â</label>
				        <input type="text" class="form-control d-inline-block" name="emp_pos_cd" value ="${EMPPOSCD}" readonly><br>
				      </div>
				      <div class="col">
				        <label>ÏÇ¨Ïõê</label>
				        	<input type="text" class="form-control d-inline-block" name="emp_cat_cd" value="${EMPCATCD}" readonly><br>
				      </div>
				    </div>
	
				    <div class="row mb-3">
				      <div class="col">
				        <label>Î∂ÄÏÑú</label>
				        	<input type="text" class="form-control d-inline-block" name="emp_dep_cd" value="${EMPDEPCD}" readonly><br>
				      </div>
				      <div class="col">
				        <label>ÌåÄ</label>
				        	<input type="text" class="form-control d-inline-block" name="emp_team_cd" value="${EMPTEAMCD}" readonly><br>
				      </div>
				    </div>
	
				    <div class="row mb-3">
				      <div class="col">
				        <label>Ï£ºÏÜå</label><br>
				        <input type="text" id="sample6_postcode" name="emp_pc" class="form-control d-inline-block w-25" value="${empPc}" required>
				        <input type="button" onclick="sample6_execDaumPostcode()" value="Ïö∞Ìé∏Î≤àÌò∏ Ï∞æÍ∏∞"><br>
				        <input type="text" id="sample6_address" name="emp_add" class="form-control" value="${empAdd}" required>
				        <input type="text" id="sample6_detailAddress" name="emp_da" class="form-control" value="${empDa}" required>
				        <input type="text" id="sample6_extraAddress" class="form-control" placeholder="Ï∞∏Í≥†Ìï≠Î™©">
				      </div>
				    </div>
				  </div>
				</div>

		<div class="modal-footer">
			<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
			<button type="submit" class="btn custom-btn-blue btn-success" id="modifyBtn">Îì±Î°ù</button>
		</div>
		`;
			modalBody.appendChild(form); // ÏµúÏ¢Ö Ìèº ÏÇΩÏûÖ
				
			modal.show();
		
			// ÏÇ¨ÏßÑ ÌååÏùº ÏÑ†ÌÉù ‚Üí ÎØ∏Î¶¨Î≥¥Í∏∞
			const imgInput   = document.getElementById('emp_img');
			const imgPreview = document.getElementById('emp_img_preview');

		
			
			imgInput.addEventListener('change', e => {
			  const file = e.target.files[0];
			  if (!file) {                      // ÏÑ†ÌÉù Ï∑®ÏÜåÌïú Í≤ΩÏö∞
			    imgPreview.style.display = 'none';
			    imgPreview.src = defaultImg;
			    return;
			  }
			  const reader = new FileReader();
			  reader.onload = evt => {
			    imgPreview.src = evt.target.result;   // ÏÑ†ÌÉùÌïú Ïù¥ÎØ∏ÏßÄ ÌëúÏãú
			  };
			  reader.readAsDataURL(file);             // Ïù¥ÎØ∏ÏßÄ ÌååÏùº ‚Üí base64 ÏùΩÍ∏∞
			});
			
		    // ÏàòÏ†ï Î≤ÑÌäº
		    modalBody.querySelector('#modifyBtn').onclick = async () => {
				/* 1Ô∏è‚É£ Î®ºÏ†Ä Î≥ëÌï©Ìï¥ÏÑú input valueÎ•º Í∞±Ïã† */
				const fullPhone = [
				    document.getElementById('emp_phone1')?.value || '',
				    document.getElementById('emp_phone2')?.value || '',
				    document.getElementById('emp_phone3')?.value || ''
				].join('-');
				document.getElementById('emp_phone').value = fullPhone;
	
				const fullEmail = [
				    document.getElementById('emp_email1')?.value || '',
				    document.getElementById('emp_email2')?.value || ''
		  		].join('@');
		  		document.getElementById('emp_email').value = fullEmail;
	
				/* 2Ô∏è‚É£ Í∞íÏù¥ Ï±ÑÏõåÏßÑ Îí§Ïóê FormDataÎ•º Îã§Ïãú ÏÉùÏÑ± */
				const form = document.getElementById('mypageForm');
				const formData = new FormData(form);
	
				const fileObj = formData.get('emp_img');
				
				/* 3Ô∏è‚É£ payloadÎ•º ÎßåÎì§ ÎïåÎäî formData ÎòêÎäî ÏßÅÏ†ë Î≥ÄÏàò ÏÇ¨Ïö©  */
				const payload = {
				    emp_nm   : formData.get('emp_nm'),
				    emp_phone: fullPhone,                           // ‚Üê ÏßÅÏ†ë Î≥ÄÏàò ÏÇ¨Ïö©
				    emp_email: fullEmail,                           // ‚Üê ÏßÅÏ†ë Î≥ÄÏàò ÏÇ¨Ïö©
				    emp_pc   : formData.get('emp_pc'),
				    emp_add  : formData.get('emp_add'),
				    emp_da   : formData.get('emp_da')
		  		};
	
				console.log('payload', payload);  // Î™®Îì† Í∞íÏù¥ Ï±ÑÏõåÏ°åÎäîÏßÄ ÌôïÏù∏
				const fd = new FormData();
	          

			    fd.append(
						  'emp',
						  new Blob([JSON.stringify(payload)], { type: 'application/json' })
						 );
			    
			    // 4-2) ÌååÏùºÏù¥ ÏÑ†ÌÉùÎèº ÏûàÏúºÎ©¥ ‚Äòemp_img‚Äô ÌååÌä∏Î°ú Ï≤®Î∂Ä
			    if (fileObj && fileObj.size > 0) {
			      fd.append('emp_img', fileObj); // fileObjÎ•º emp_imgÎùºÎäî Ïù¥Î¶ÑÏúºÎ°ú ÎÑ£ÎäîÎã§
			    }
				
	            const response = await fetch('/SOLEX/mypage/personalDataModify', {
			    	method : 'PUT',
			    	body   : fd
				});
	            
	            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('exampleModal'));
	            alert('ÏàòÏ†ï ÏôÑÎ£å');
	            modalInstance.hide();
			}
		}
		
		function sample6_execDaumPostcode() {	
		    new daum.Postcode({
		        oncomplete: function(data) {
		            // Ï£ºÏÜå Î≥ÄÏàò
		            var addr = ''; // Ï£ºÏÜå
		            var extraAddr = ''; // Ï∞∏Í≥†Ìï≠Î™©

		            // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÌïú Ï£ºÏÜå ÌÉÄÏûÖÏóê Îî∞Îùº Ìï¥Îãπ Ï£ºÏÜå Í∞íÏùÑ Í∞ÄÏ†∏Ïò®Îã§.
		            if (data.userSelectedType === 'R') { // ÎèÑÎ°úÎ™Ö Ï£ºÏÜå
		                addr = data.roadAddress;
		            } else { // ÏßÄÎ≤à Ï£ºÏÜå
		                addr = data.jibunAddress;
		            }

		            // Ï∞∏Í≥†Ìï≠Î™©
		            if(data.userSelectedType === 'R'){
		                if(data.bname !== '' && /[Îèô|Î°ú|Í∞Ä]$/g.test(data.bname)){
		                    extraAddr += data.bname;
		                }
		                if(data.buildingName !== '' && data.apartment === 'Y'){
		                    extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
		                }
		                if(extraAddr !== ''){
		                    extraAddr = ' (' + extraAddr + ')';
		                }
		                document.getElementById("sample6_extraAddress").value = extraAddr;
		            } else {
		                document.getElementById("sample6_extraAddress").value = '';
		            }

		            // Ïö∞Ìé∏Î≤àÌò∏ÏôÄ Ï£ºÏÜå Ï†ïÎ≥¥Î•º Ìï¥Îãπ ÌïÑÎìúÏóê ÎÑ£ÎäîÎã§.
		            document.getElementById('sample6_postcode').value = data.zonecode;
		            document.getElementById("sample6_address").value = addr;

		            // ÏÉÅÏÑ∏Ï£ºÏÜå ÏûÖÎ†•Ïπ∏ÏúºÎ°ú Ìè¨Ïª§Ïä§ Ïù¥Îèô
		            document.getElementById("sample6_detailAddress").focus();
		        }
		    }).open();
		}
	</script>
</th:block>