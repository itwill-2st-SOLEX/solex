<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="kr.co.itwillbs.solex.code.CodeMapper">

	<!-- 공통코드 리스트 조회 -->
	<select id="getCodeList" resultType="kr.co.itwillbs.solex.code.CodeDTO">
		SELECT	*
		FROM	CODE
	</select>
	
	<!-- 공통코드 무한스크롤 -->
	<select id="selectPagedCodeList" resultType="kr.co.itwillbs.solex.code.CodeDTO">
		SELECT * FROM (
			SELECT t.*, ROWNUM rnum FROM (
				SELECT * FROM code
				<where>
					<if test="codYn != null and codYn != ''">
						cod_yn = #{codYn}
					</if>
				</where>
				<choose>
					<when test="sort != null and dir != null">
						ORDER BY ${sort} ${dir}
					</when>
				<otherwise>
					ORDER BY cod_id ASC
				</otherwise>
				</choose>
			) t
			WHERE ROWNUM &lt;= #{offset} + #{perPage}
		)
		WHERE rnum &gt; #{offset}
	</select>
	
	<select id="selectTotalCount" resultType="int">
		SELECT COUNT(*) FROM code
		<where>
			<if test="codYn != null and codYn != ''">
			cod_yn = #{codYn}
			</if>
		</where>
	</select>
	
	<!-- 공통코드 신규 행 추가 -->
	<insert id="insertCodes">
		INSERT INTO CODE (
			COD_ID,
			COD_NM,
			COD_YN,
			COD_REG_TIME
		)
		VALUES
		<foreach collection="list" item="code" separator=",">
			( 이렇게 하면 안된데~~ 오라클은 안되는거래~
				#{code.cod_id},
				#{code.cod_nm},
				#{code.cod_yn},
				sysdate
			)
		</foreach>
	</insert>
	
	<!-- 공통코드 기존 행 수정 -->
	<update id="updateCodes">
		<foreach collection="list" item="code" separator=";">
			UPDATE CODE
			SET
			COD_NM = #{code.cod_nm},
			COD_YN = #{code.cod_yn}
			WHERE
			COD_ID = #{code.cod_id}
		</foreach>
	</update>
	
	<!-- 상세공통코드 무한스크롤 -->
	<select id="selectPagedDetailCodeList" resultType="map">
		SELECT	DET_ID, DET_NM, DET_YN, DET_SORT, COD_ID
		FROM	CODE_DETAIL
		WHERE	COD_ID = #{codId}
		<choose>
			<when test="sortColumn != null and sortDirection != null">
				ORDER BY
					<choose>
						<when test="sortColumn == 'DET_ID'">DET_ID</when>
						<when test="sortColumn == 'DET_NM'">DET_NM</when>
						<when test="sortColumn == 'DET_YN'">DET_YN</when>
						<when test="sortColumn == 'DET_SORT'">DET_SORT</when>
						<otherwise>DET_SORT</otherwise>
					</choose>
					<choose>
						<when test="sortDirection == 'desc'">DESC</when>
						<otherwise>ASC</otherwise>
					</choose>
			</when>
			<otherwise>
				ORDER BY DET_SORT ASC
			</otherwise>
		</choose>
		OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
	</select>
	
	<select id="selectDetailCodeTotalCount" resultType="int">
		SELECT	COUNT(*)
		FROM	CODE_DETAIL
		WHERE	COD_ID = #{codId}
	</select>
	
	<!-- 상세공통코드 신규 행 추가 -->
	<insert id="insertDetailCodes" parameterType="map">
		INSERT INTO CODE_DETAIL (DET_ID, DET_NM, DET_YN, DET_SORT, COD_ID)
		<foreach collection="list" item="codeDetail" separator=";">
			VALUES (#{codeDetail.DET_ID},
					#{codeDetail.DET_NM},
					#{codeDetail.DET_YN},
					#{codeDetail.DET_SORT},
					#{codeDetail.COD_ID})
		</foreach>
	</insert>
	
	<!-- 상세공통코드 기존 행 수정 -->
	<update id="updateDetailCodes" parameterType="map">
		<foreach collection="list" item="codeDetail" separator=";">
			UPDATE CODE_DETAIL
			SET DET_NM = #{codeDetail.DET_NM},
				DET_YN = #{codeDetail.DET_YN},
				DET_SORT = #{codeDetail.DET_SORT}
			WHERE DET_ID = #{codeDetail.DET_ID}
			AND COD_ID = #{codeDetail.COD_ID}
		</foreach>
	</update>
</mapper>