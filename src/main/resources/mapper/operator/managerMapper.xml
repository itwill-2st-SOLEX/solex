<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="kr.co.itwillbs.solex.operator.ManagerMapper">	
  
  	
  	<!-- 로그인한 사람에 해당하는 공정 정보 가져오기 -->
  	<select id="getManagerSummary">
  	                
		SELECT DISTINCT pr.prc_code,         <!-- 공정코드 -->
		       		    pr.prc_nm,         <!-- 공정이름 -->
		       		    cd1.det_nm || ' ' || cd2.det_nm AS dep_nm,  <!-- 부서 + 팀명 -->
		       		    qi.qua_nm,		       		    
		       		    ve.emp_id
  		FROM   process pr JOIN work_order wo      ON pr.prc_id = wo.prc_id 
                  		  JOIN work_process wp    ON wo.wrk_id = wp.wrk_id 
  						  JOIN quality_item qi    ON pr.qua_id = qi.qua_id
  						  JOIN code_detail cd1    ON pr.det_id = cd1.det_id      
  						  JOIN code_detail cd2    ON wp.wpo_team = cd2.det_id   
  						  JOIN view_employee ve   ON ve.emp_dep_nm = cd1.det_nm
                         									AND ve.emp_team_nm = cd2.det_nm
 		WHERE ve.emp_id = #{empId}
  	</select>
  	
  	<!-- 자신에게 해당하는 작업현황 전체 목록 가져오기 -->
  	<select id="getManagerList">
		SELECT
		    wo.wrk_id, 			<!-- 작업지시ID  -->
		    vs.prd_code,		<!-- 공정ID -->
		    vs.prd_nm,			<!-- 제품명 -->
		    
		    vs.prd_color,		<!-- 제품유형(색상) -->
		    vs.prd_size,		<!-- 제품유형(사이즈) -->
		    vs.prd_height,		<!-- 제품유형(굽높이) -->
		    vs.odd_id,			<!-- 수주번호 -->
		    vs.odd_cnt,			<!-- 주문수량 -->
		    
		    wp.wpo_id,
		    wp.wpo_ocount,		<!-- 작업지시수량 -->
            wp.wpo_jcount,		<!-- 작업완료수량 -->
            qh.qhi_bcount,		<!-- 불량수량 -->
			
			wp.wpo_status,
		    cd.det_nm AS wpo_status_Name,	<!-- 생산상태 -->
			vs.ord_end_date,		<!-- 납품기일 -->
		    wp.wpo_team,		<!-- 팀 -->
		    wp.wpo_step			<!-- 작업순서 -->
		
		FROM
		    work_order wo			<!-- 작업지시 -->
		    JOIN process p ON wo.prc_id = p.prc_id			<!-- 공정-작업지시 -->
		    JOIN work_process wp ON wp.wrk_id = wo.wrk_id		<!-- 공정-작업순서 -->
		    JOIN vw_suju_summary vs ON wo.odd_id = vs.odd_id	<!-- 공정-제품상세(수주 뷰) -->
		    LEFT JOIN code_detail cd ON wp.wpo_status = cd.det_id	<!-- 상세공코-작업상태 -->
			LEFT JOIN quality_item qi ON p.qua_id = qi.qua_id AND qi.qua_type='qua_type_03'
			LEFT JOIN quality_history qh ON qi.qua_id = qh.qua_id AND wp.wpo_id=qh.qhi_target_id		
			
		JOIN (			<!-- 접속한 사람의 부서와 팀에 해당하는 자료 조회하기 위한 서브쿼리 -->
	        SELECT e.emp_dep_nm, e.emp_team_nm, emp.emp_dep_cd, emp.emp_team_cd
	        FROM VIEW_EMPLOYEE e
	        JOIN EMPLOYEE emp ON e.emp_id = emp.emp_id
	        WHERE e.emp_id = #{empId}
	    ) my_emp ON TRIM(LOWER(wp.wpo_team)) = TRIM(LOWER(my_emp.emp_team_cd))
		             AND p.det_id = my_emp.emp_dep_cd
		WHERE wp.wpo_status != 'wpo_sts_00' <!-- 작업대기상태 -->
		ORDER BY
		    wo.wrk_id,
		    CASE 
		        WHEN wp.wpo_status = 'wpo_sts_09' THEN 99
		        <!-- ELSE TO_NUMBER(SUBSTR(wp.wpo_status, -2)) -->
		    END
  		<!-- OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY -->

  	</select>
  	
  	<!-- 작업지시 전체 개수 가져오기(무한스크롤) -->
  	<select id="getManagerCount">
  		SELECT COUNT(*) AS ALLCOUNT
		FROM
		    work_order wo			<!-- 작업지시 -->
		    JOIN process p ON wo.prc_id = p.prc_id			<!-- 공정-작업지시 -->
		    JOIN work_process wp ON wp.wrk_id = wo.wrk_id		<!-- 공정-작업순서 -->
		    JOIN vw_suju_summary vs  ON wo.odd_id = vs.odd_id	<!-- 공정-제품상세(수주 뷰) -->
		    LEFT JOIN code_detail cd ON wp.wpo_status = cd.det_id	<!-- 상세공코-작업상태 -->
		
		JOIN (			<!-- 접속한 사람의 부서와 팀에 해당하는 자료 조회하기 위한 서브쿼리 -->
	        SELECT e.emp_dep_nm, e.emp_team_nm, emp.emp_dep_cd, emp.emp_team_cd
	        FROM VIEW_EMPLOYEE e
	        JOIN EMPLOYEE emp ON e.emp_id = emp.emp_id
	        WHERE e.emp_id = #{empId}
	    ) my_emp ON TRIM(LOWER(wp.wpo_team)) = TRIM(LOWER(my_emp.emp_team_cd))
		             AND p.det_id = my_emp.emp_dep_cd
		WHERE wp.wpo_status != 'wpo_sts_00' <!-- 작업대기상태 -->
	</select>
	
	<!-- 사원이 작업수량 업데이트 하면, work_process 작업 수량도 업데이트 되도록 설정-->
	<update id="updateJcount">
		UPDATE work_process wp
		SET wp.wpo_jcount = (
			    SELECT NVL(SUM(wr.wre_jcount), 0)
			    FROM work_report wr
			    WHERE wr.wpo_id = wp.wpo_id
		)
		WHERE wp.wpo_id = #{wpoId}
	</update>
	
	<!-- 작업 상태 업데이트 -->
	<!-- 상태 : wpo_sts_01 작업시작 -> 02 작업중 -->
	<!-- 	>> 상태 변경, 공정 시작일 입력 -->
	<update id="updateWpoSts02">
		UPDATE work_process
		SET wpo_status=#{wpoStatus}, wpo_start_date=#{wpoStartDate}
		WHERE wpo_id = #{wpoId}
	</update>
	
	<!-- 상태 : wpo_sts_02 작업중 -> 03 작업완료-->
	<!-- 	 >> 작업 지시 수량과 사원 입력값 확인  -->
	<select id="selectWpoSts03">
		SELECT wpo_ocount, wpo_jcount
		FROM work_process
		WHERE wpo_id = #{wpoId}
	</select>
		<!-- 	 >> 작업 완료 상태로 변경 -->
	<update id="updateWpoSts03">
 		UPDATE work_process
		SET wpo_status=#{wpoStatus}
		WHERE wpo_id=#{wpoId}
	</update>
	
	<!-- 상태 : wpo_sts_03 작업완료 -> 04 품질검사중 --> 
	<!-- 	>> 공정완료 -> 품질검사중으로 변경  -->
	<update id="updateWpoSts04">
 		UPDATE work_process
		SET wpo_status=#{wpoStatus}
		WHERE wpo_id = #{wpoId}
	</update>

	<!-- 	>> 품질 이력 테이블에 추가하기 위해 품질검사 id, 작업프로세스 id 가져오기  -->
	<select id="selectWpoSts04">
 		SELECT wp.wpo_id, pr.qua_id
	    FROM work_process wp
	    JOIN work_order wo ON wp.wrk_id = wo.wrk_id
	    JOIN process pr ON wo.prc_id = pr.prc_id
	    WHERE wpo_id = #{wpoId}
	</select>
	
	<!-- 	>> 품질 이력 테이블에 추가  -->
	<insert id="insertWpoSts04"  useGeneratedKeys="true" keyProperty="qhiId">
 		INSERT INTO quality_history(qhi_target_id, qua_id, qhi_start_date, qhi_emp_id)
 		VALUES (#{wpoId}, #{quaId}, #{qhiStartDate}, #{qhiEmpId})
	</insert>
	
	<!-- 상태 : wpo_sts_04 품질검사중 -> 05 품질검사완료 -->
	<!-- 	>> 불량개수, 상태 업데이트 -->
	<update id="updateWpoSts05_wp">
		UPDATE work_process
		SET wpo_status=#{wpoStatus}
		WHERE wpo_id = #{wpoId}
	</update>
	
	<!--  	>> 검사 완료를 위해 품질검사id 찾아오기 -->
	<select id="selectWpoSts05">
		SELECT qh.qhi_id
		FROM quality_history qh
			JOIN work_process wp ON qh.qhi_target_id = wp.wpo_id
			JoIN quality_item qi ON qh.qua_id = qi.qua_id
		WHERE wp.wpo_id = #{wpoId} AND qi.qua_type='qua_type_03'
	</select>
	
	<!-- 	>> 품질검사이력 테이블에도 업데이트 -->
	<update id="updateWpoSts05_qh">
		UPDATE quality_history
		SET qhi_bcount=#{qhiBcount}, qhi_end_date = #{qhiEndDate}
		WHERE qhi_id=#{qhiId}
	</update>
	
	
	<!-- 상태 : wpo_sts_05 품질검사완료 -> 09 공정이관완료 -->
	<!-- 	>> 불량개수, 상태 업데이트 -->
	<update id="updateWpoSts09_curr">
		UPDATE work_process
		SET wpo_status=#{wpoStatus}, wpo_end_date=#{wpoEndDate}
		WHERE wpo_id=#{wpoId}
	</update>
	
	<!--  	>> 다음 공정 상태 변경하기 -->
	
  	<!-- 현재 작업중인 공정의 총 공정단계 수, 주문id찾기 -->
  	<select id="selectStepInfo">
	    SELECT
		    wp1.wpo_id,
		    wp1.wrk_id,
		    wo1.odd_id,
		    
		    <!-- 총 공정 개수 -->
		    (SELECT COUNT(*)
		     FROM work_process wpx
		     JOIN work_order  wox ON wpx.wrk_id = wox.wrk_id
		     WHERE wox.odd_id = wo1.odd_id)   AS total_steps,
		    
		    <!-- 현재 공정 순서 -->
		    TO_NUMBER(wp1.wpo_step)           AS step,
		    
		    <!-- 다음 공정 번호 -->
		    ( SELECT MIN(TO_NUMBER(wp2.wpo_step))
		     FROM work_process wp2
		     JOIN work_order   wo2 ON wp2.wrk_id = wo2.wrk_id
		     WHERE wo2.odd_id = wo1.odd_id
		       AND TO_NUMBER(wp2.wpo_step) = TO_NUMBER(wp1.wpo_step) + 1) AS next_step,
		    
		    wp1.wpo_jcount,
		    NVL(qh.qhi_bcount,0)             AS bcount,
		    
		    <!-- 다음 공정 ID(한 건만 필요하면 MIN/ROWNUM)  -->
		     (SELECT MIN(wp2.wpo_id)          
		     FROM work_process wp2
		     	JOIN work_order   wo2 ON wp2.wrk_id = wo2.wrk_id
		     WHERE wo2.odd_id = wo1.odd_id
		       AND TO_NUMBER(wp2.wpo_step) = TO_NUMBER(wp1.wpo_step) + 1) AS next_wpo_id
		
		FROM   work_process   wp1
		JOIN   work_order     wo1 ON wp1.wrk_id = wo1.wrk_id
		LEFT   JOIN quality_history qh ON qh.qhi_target_id = wp1.wpo_id
		WHERE  wp1.wpo_id = #{wpoId}
  	</select>
  	
  	<!-- 다음 공정의 시작일, 상태값, 작업지시수량 업데이트-->
  	<update id="updateNextStep">
  		UPDATE work_process
  		SET wpo_status = #{wpoNewStatus}, wpo_start_date=#{wpoStartDate}, wpo_ocount=#{wpoOcount}
  		WHERE wpo_id=#{wpoId}
  	</update>
  	
  	<!-- 수주 테이블에 실제로 작업이 완료된 값을 업데이트하기 -->
  	<update id="updateSujuDetail">
		UPDATE suju_order_detail sod
		SET sod.odd_actual_cnt = #{wpoOcount}, sod.odd_sts = 'odd_sts_04', sod.odd_mod_date=#{oddModDate}
		WHERE sod.odd_id IN (
		         SELECT wo.odd_id
		         FROM work_order wo
		         	JOIN work_process wp ON wp.wrk_id = wo.wrk_id
		         WHERE wp.wpo_id = #{wpoId}
		)
  	</update>
  	
  	<!-- 그리드에서 현황 클릭했을 때 사원 작업 현황 표시하기 -->
  	  	
  	<!-- 사원별 생산량 합계 -->
  	<select id="selectWorkerList">
  		SELECT wr.emp_id, ve.emp_num, ve.emp_nm, wr.wre_jcount, wr.wre_date, wre_memo
        FROM work_report wr JOIN view_employee ve ON wr.emp_id=ve.emp_id
        WHERE wr.emp_id=#{empId} AND wr.wpo_id = #{wpo_id}
        GROUP BY wr.wre_date desc
  	</select>
  	
  	<!-- 사원별 생산량 합계 -->
  	<select id="selectWorkerSum">
  		SELECT wr.emp_id, ve.emp_num, ve.emp_nm, sum(wr.wre_jcount) as emp_sum
        FROM work_report wr JOIN view_employee ve ON wr.emp_id=ve.emp_id
        WHERE wr.emp_id=#{empId} AND wr.wpo_id = #{wpo_id}
        GROUP BY wr.emp_id, ve.emp_num, ve.emp_nm
  	</select>

	
  </mapper>
	