<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.itwillbs.solex.sales.OrderMapper">
  <select id="selectPagedOrderDataAsMap" parameterType="Map" resultType="Map">
  	SELECT
    	ord.ord_id,
        prd.prd_nm,
        cli.cli_nm,
        odd.odd_cnt,
        NVL(odd.odd_add, '') || ' ' || NVL(odd.odd_da, '') AS ODD_ADDRESS,
        cd.det_nm,
        TO_CHAR(odd.odd_mod_date, 'YYYY-MM-DD') AS ORD_MOD_DATE
    FROM suju_order ord
    left JOIN suju_order_detail odd ON odd.ord_id = ord.ord_id
    left JOIN client cli ON ord.cli_id = cli.cli_id
    left JOIN product_option opt ON opt.opt_id = odd.opt_id
    left JOIN product prd ON prd.prd_cd = opt.prd_cd
    left JOIN code_detail cd ON odd.odd_sts = cd.det_id
    <if test="searchKeyword != null and searchKeyword != ''">
        AND (
            cli.cli_nm LIKE '%' || #{searchKeyword} || '%' OR  -- 거래처명 검색
            prd.prd_nm LIKE '%' || #{searchKeyword} || '%' OR  -- 상품명 검색
            prd.prd_cd LIKE '%' || #{searchKeyword} || '%'     -- 상품코드도 검색에 포함
        )
    </if>
    ORDER BY cd.det_sort asc
    OFFSET #{offset} ROWS
    FETCH NEXT #{limit} ROWS ONLY
</select>


<select id="getSearchClientList" parameterType="Map" resultType="Map">
    SELECT
    	cli_nm, cli_id
    FROM client
    <where>
	  cli_type = 'BUYER'
      <!-- searchKeyword 가 있을 때만 WHERE 절 추가 -->
      <if test="searchKeyword != null and searchKeyword != ''">
        AND LOWER(cli_nm) LIKE '%' || #{searchKeyword} || '%'
      </if>
    </where>
    ORDER BY cli_nm
    OFFSET #{offset} ROWS
    FETCH NEXT #{limit} ROWS ONLY
</select>


  
  <select id="countClientsByEmployeeId" resultType="int">
  	SELECT count(*)
  	FROM client
  	WHERE emp_id = #{emp_id} and cli_type = 'BUYER' 
  </select>
  
  <select id="getSelectClientsByEmployeeId" resultType="Map">
  	SELECT cli_nm
  	FROM client
  	WHERE emp_id = #{emp_id}
  	and cli_type = 'BUYER'
  	ORDER BY cli_nm 
  </select>
  
  <select id="getSelectTop5PopularClients" resultType="Map">
    SELECT
    	cli_nm, cli_id
    FROM (
        SELECT
            cli.cli_nm,cli.cli_id,
            COUNT(suju.cli_id) AS order_count
        FROM client cli 
        JOIN suju_order suju    
        ON cli.cli_id = suju.cli_id
        WHERE cli.cli_type = 'BUYER'    
        GROUP BY
            cli.cli_nm,cli.cli_id
        ORDER BY order_count DESC
    )
    WHERE ROWNUM <![CDATA[ <= ]]> 5
   </select>
   
   <select id="getSelectTop5PopularProducts" resultType="Map">
    SELECT
    	prd_nm, prd_cd
    FROM (
        SELECT
	        p.prd_nm,
	        p.prd_cd,
	        SUM(od.odd_cnt) AS total_sales
	    FROM
	        product p 
	    JOIN
	        product_option opt ON p.prd_cd = opt.prd_cd 
	    JOIN
	        suju_order_detail od ON opt.opt_id = od.opt_id 
	    GROUP BY
	        p.prd_nm, p.prd_cd
	    ORDER BY
	        total_sales DESC
    	)
    WHERE ROWNUM <![CDATA[ <= ]]> 5
   </select>
   
   
	<select id="getSearchProductList" parameterType="Map" resultType="Map">
	    SELECT
	    	prd_nm, prd_cd
	    FROM product
	    <where>
	      <!-- searchKeyword 가 있을 때만 WHERE 절 추가 -->
	      <if test="searchKeyword != null and searchKeyword != ''">
	        AND LOWER(prd_nm) LIKE '%' || #{searchKeyword} || '%'
	      </if>
	    </where>
	    ORDER BY prd_nm
	</select>

	<!-- 컬러 -->
	<select id="getColorsByProduct" resultType="Map">
		SELECT DISTINCT opt.opt_color, cd.det_nm
		FROM product_option opt 
		LEFT JOIN code_detail cd 
		ON cd.det_id = opt.opt_color
		WHERE prd_cd = #{prd_cd}
	</select>

	<!-- 사이즈 -->
	<select id="getSizesByProductAndColor" resultType="Map">
		SELECT DISTINCT opt.opt_size , cd.det_nm
		FROM product_option opt
		LEFT JOIN code_detail cd 
		ON cd.det_id = opt.opt_size
		WHERE prd_cd = #{prd_cd}
		AND opt.opt_color = #{opt_color}
	</select>
	
	<!-- 사이즈 -->
	<select id="getHeightsByProductColorSize" resultType="Map">
		SELECT DISTINCT opt.opt_height , cd.det_nm
		FROM product_option opt
		LEFT JOIN code_detail cd 
		ON cd.det_id = opt.opt_height
		WHERE prd_cd = #{prd_cd}
		AND opt.opt_color = #{opt_color}
		AND opt.opt_size = #{opt_size}
	</select>
	
	<select id="getStockCount" resultType="int">		
		SELECT stk.stk_cnt
		FROM  stock stk
		LEFT JOIN product_option opt
		ON opt.opt_id = stk.item_id
		WHERE stk.stk_cat = 'stk_cat_01'
		AND opt.prd_cd = #{prd_cd}
		AND opt.opt_color = #{opt_color}
		AND opt.opt_size = #{opt_size}
		AND opt.opt_height = #{opt_height}
	</select>
	
	
	
	<select id="getOptionIdByCombination" resultType="string">
		SELECT opt_id
		FROM product_option
		WHERE prd_cd = #{prd_cd}
		AND opt_color = #{opt_color}
		AND opt_size = #{opt_size}
		AND opt_height = #{opt_height}
	</select>

	<!-- 자재 부족 계산 -->
	<select id="getLackingMaterialsWithMine" resultType="map">
	   SELECT
	    r.mat_id,
	    r.mat_nm,
	    NVL(s.stk_cnt, 0) AS current_stock,
	    r.required_qty_total,
	    r.required_qty_mine,
	    (NVL(s.stk_cnt, 0) - r.required_qty_total) AS shortage
	  FROM (
	    SELECT
	      b.mat_id,
	      m.mat_nm,
	      SUM(b.bom_cnt * d.odd_cnt) AS required_qty_existing,
	      (
	        SELECT bom_cnt * #{odd_cnt}
	        FROM bom b2
	        WHERE b2.opt_id = #{opt_id}
	          AND b2.mat_id = b.mat_id
	      ) AS required_qty_mine,
	      SUM(b.bom_cnt * d.odd_cnt) +
	      (
	        SELECT bom_cnt * #{odd_cnt}
	        FROM bom b2
	        WHERE b2.opt_id = #{opt_id}
	          AND b2.mat_id = b.mat_id
	      ) AS required_qty_total
	    FROM suju_order_detail d
	    JOIN bom b ON b.opt_id = d.opt_id
	    JOIN material m ON m.mat_id = b.mat_id
	    WHERE d.odd_sts IN ('ord_sts_00', 'ord_sts_01', 'ord_sts_02')
	    GROUP BY b.mat_id, m.mat_nm
	  ) r
	  LEFT JOIN stock s ON s.item_id = r.mat_id AND s.stk_cat = 'stk_cat_02'
	  WHERE (NVL(s.stk_cnt, 0) - r.required_qty_total) &lt; 0
	</select>
	
	
	
  	<!-- 주문 등록 트랜잭션 시작 -->
  	<!-- 1. 수주테이블 등록 -->
  	<insert id="createSujuOrder" parameterType="map" useGeneratedKeys="true" keyColumn="ord_id"  keyProperty="ord_id">
  		INSERT INTO suju_order(cli_id, emp_id, ord_reg_date)
  			VALUES(#{cli_id},#{emp_id},SYSDATE)
  	</insert>
  	
  	<!-- 2. 수주 상세테이블 등록 -->
  	<insert id="createSujuOrderDetail">
  		INSERT INTO suju_order_detail(
  		  ord_id, opt_id, odd_cnt, odd_end_date, odd_sts, odd_pc, odd_add, odd_da, odd_pay, odd_pay_date, odd_mod_date 
  		)
  			VALUES(
  			#{ord_id}, #{opt_id}, #{odd_cnt}, #{odd_end_date}, #{ord_sts}, #{odd_pc}, #{odd_add},#{odd_da}, #{odd_pay}, #{odd_pay_date}, SYSDATE)
  	</insert>
  	<!-- 주문 등록 트랜잭션 끝 -->
  	
  	
  	<!-- 지금 사용안함 수주요청 테이블 메뉴에서 작업할때 필요함  -->  	
  	<!-- 지금 사용안함 수주요청 테이블 메뉴에서 작업할때 필요함  -->  	
  	<!-- 지금 사용안함 수주요청 테이블 메뉴에서 작업할때 필요함  -->  	
  	<!-- 부족한 수량을 가져옴 -->
  	<select id="getLackingMaterials" parameterType="map" resultType="map">
	    SELECT
	        b.mat_id,
	        ( (b.bom_cnt * #{ord_cnt}) - s.stk_cnt ) AS lacking_qty
	    FROM
	        BOM b
	    JOIN
	        STOCK s ON b.mat_id = s.item_id
	    WHERE
	        b.prd_cd = #{prd_cd}
	        AND s.stk_cnt &lt; (b.bom_cnt * #{ord_cnt})
	        AND s.stk_cat = 'stk_cat_02'
	</select>
	
	<!-- 부족한 수량을 발주 테이블에 insert -->
	<insert id="createPurchaseRequest" parameterType="map">
    INSERT INTO  (
        mat_id,
        emp_id,
        mat_reg_date
    ) VALUES (
        #{ord_id},      -- 서비스단에서 추가해준 주문 ID
        #{MAT_ID},      -- getLackingMaterials에서 조회한 자재 ID
        #{lacking_qty}  -- getLackingMaterials에서 계산한 부족 수량
    )
	</insert>
	
  	<!-- 지금 사용안함 수주요청 테이블 메뉴에서 작업할때 필요함  -->  	
  	<!-- 지금 사용안함 수주요청 테이블 메뉴에서 작업할때 필요함  -->  	
  	<!-- 지금 사용안함 수주요청 테이블 메뉴에서 작업할때 필요함  -->  	
	
	
  	
  	
  	
	


	
  	
  	
	
  
  
  
</mapper>
