<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.itwillbs.solex.lot.LotMapper">

	<!-- 제품유형 리스트 조회 -->
	<select id="selectDetailCodeListByCodId" resultType="map">
		SELECT
		DET_ID,
		DET_NM
		FROM CODE_DETAIL
		WHERE COD_ID = #{codId}
		ORDER BY DET_SORT
	</select>

	<!-- 완제품 -->
	<select id="getFilteredProductLots" parameterType="map" resultType="map">
		SELECT
			'prd_' || PRD_LOT_ID AS ID,
			PRD_LOT_CODE || ' (' || CD.DET_NM || ')' AS TEXT,
			1 AS CHILDREN
		FROM PRODUCT_LOT PL
		JOIN CODE_DETAIL CD ON PL.PRD_LOT_STATUS = CD.DET_ID
		WHERE 1 = 1
		<if test="lotCode != null and lotCode != ''">
			AND PL.PRD_LOT_CODE LIKE '%' || #{lotCode} || '%'
		</if>
		<if test="lotStatus != null">
			AND PL.PRD_LOT_STATUS = #{lotStatus}
		</if>
		<if test="prdType != null">
			AND PL.PRD_TYPE_ID = #{prdType}
		</if>
		ORDER BY PRD_LOT_ID DESC
	</select>

	<!-- 공정 -->
	<select id="selectProcessLotNodes" resultType="map">
		SELECT
		    'prc_' || pl.PRC_LOT_ID AS ID,
		    p.PRC_NM || ' / ' || p.PRC_CODE AS TEXT,
		    CASE
		        WHEN EXISTS (
		            SELECT 1 FROM processLot_matLot_mapping pm WHERE pm.PRC_LOT_ID = pl.PRC_LOT_ID
		            UNION
		            SELECT 1 FROM processLot_equipment_mapping pe WHERE pe.PRC_LOT_ID = pl.PRC_LOT_ID
		        )
		        THEN 1 ELSE 0
		    END AS CHILDREN
		FROM process_lot pl
		JOIN prdLot_processLot_mapping map ON pl.PRC_LOT_ID = map.PRC_LOT_ID
		JOIN process p ON pl.PRC_ID = p.PRC_ID
		WHERE map.PRD_LOT_ID = #{prdLotId}
	</select>

	<!-- 자재 + 설비목록 -->
	<select id="selectMaterialAndEquipmentNodes" resultType="map">
		SELECT * FROM (
	        -- 자재 LOT
	        SELECT
	            'mat_' || ml.MAT_LOT_ID AS ID,
	            '자재: ' || m.MAT_NM || ' (' || ml.MAT_LOT_CODE || ')' AS TEXT,
	            0 AS CHILDREN
	        FROM material_lot ml
	        JOIN processLot_matLot_mapping map ON ml.MAT_LOT_ID = map.MAT_LOT_ID
	        JOIN material m ON ml.MAT_ID = m.MAT_ID
	        WHERE map.PRC_LOT_ID = #{prcLotId}
	
	        UNION ALL
	
	        -- 설비 LOT
	        SELECT
	            'equ_' || e.EQP_ID AS ID,
	            '설비: ' || e.EQP_NAME || ' (' || e.EQP_CODE || ')' AS TEXT,
	            0 AS CHILDREN
	        FROM equipment e
	        JOIN processLot_equipment_mapping map ON e.EQP_ID = map.EQU_ID
	        WHERE map.PRC_LOT_ID = #{prcLotId}
	    )
	</select>

</mapper>