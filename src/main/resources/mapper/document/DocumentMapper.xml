<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.itwillbs.solex.document.DocumentMapper">
<!--	기안서 종류 공통코드-->
	<select id="getdocTypeList" resultType="map">
		SELECT det_id, det_nm
		  FROM code_detail
		 WHERE cod_id = 'doc_type'
		   AND det_yn = 'y'
	</select>
	
<!--	올린 기안서 목록-->
	<select id="selectDraftList" resultType="map">
		SELECT d.doc_id,
			   c.det_id AS doc_type_code,
		       c.det_nm AS doc_type,
		       s.det_nm AS doc_sts,
		       TO_CHAR(d.doc_reg_time, 'YYYY-MM-DD HH24:MI:SS') AS doc_reg_time
		  FROM document d
		  LEFT JOIN code_detail c
		    ON d.doc_type = c.det_id
		  LEFT JOIN code_detail s 
		    ON d.doc_sts  = s.det_id
		 ORDER BY doc_reg_time DESC
        OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
  	</select>
  
<!--   직급 공통코드 불러오기  -->
	<select id="getPosition" resultType="map" parameterType="string">
		SELECT det_id, det_nm
      FROM code_detail
     WHERE cod_id = 
       <choose>
         <when test="group == 'dep_erp' or group == 'team'">
           'dept'
         </when>
         <otherwise>
           #{group}
         </otherwise>
       </choose>
       AND det_yn = 'y'
       <if test="group == 'dep_erp'">
         AND det_id LIKE 'dept#___' ESCAPE '#'
       </if>
       <if test="group == 'team'">
          AND det_nm like '%팀'
       </if>
	</select>
	
<!-- 	기안서 등록  반연차 테이블에 doc_id를 넘겨줘야 해서 keyProperty 넘김-->
	<insert id="registerDocument" parameterType="map">
		<selectKey keyProperty="doc_id" resultType="int" order="BEFORE">
		    SELECT doc_seq.NEXTVAL FROM dual
		</selectKey>
		INSERT INTO document (doc_id,
							  doc_type,
					          emp_id,
					          doc_reg_time
    	) VALUES (#{doc_id},
    		      #{doc_type},
		          #{emp_id},
		          SYSDATE
    	)
	</insert>
	
<!-- 	반연차 등록 -->
	<insert id="registerLeaveDoc" parameterType="map">
		INSERT INTO leave_doc (doc_id,
							   lea_type,
					           lea_start_date,
					           lea_end_date,
					           lea_tt,
					           lea_con
    	) VALUES (#{doc_id},
    			  #{lea_type},
		          TO_DATE(#{lea_start_date}, 'YYYY-MM-DD HH24:MI'),
		          TO_DATE(#{lea_end_date}, 'YYYY-MM-DD HH24:MI'),
		          #{lea_tt},
		          #{lea_con}
   		)
	</insert>
<!--	출장/외근 등록-->
	<insert id="registerbusinessOutworkDoc" parameterType="map">
		INSERT INTO business_outwork_doc (doc_id,
									 	  bus_type,
							           	  bus_start_time,
							          	  bus_end_time,
							           	  bus_cost,
							           	  bus_con
    	) VALUES (#{doc_id},
    			  #{bus_type},
		          TO_DATE(#{bus_start_time}, 'YYYY-MM-DD HH24:MI'),
		          TO_DATE(#{bus_end_time}, 'YYYY-MM-DD HH24:MI'),
		          #{bus_cost},
		          #{bus_con}
   		)
	</insert>
<!--	사직서 등록-->
	<insert id="resignationDoc" parameterType="map">
		INSERT INTO resignation_doc (doc_id,
						           	 res_start_date,
						          	 res_con
    	) VALUES (#{doc_id},
		          TO_DATE(#{res_start_date}, 'YYYY-MM-DD'),
		          #{res_con}
   		)
	</insert>
	
<!--	기안서 상세조회-->
	<select id="selectDetailDoc" resultType="map">
		SELECT *
		  FROM document d
		  LEFT JOIN resignation_doc r
		    ON d.doc_id = r.doc_id
		  LEFT JOIN leave_doc l
		   ON d.doc_id = l.doc_id
		  LEFT JOIN business_outwork_doc b
		    ON d.doc_id = b.doc_id
		 WHERE d.doc_id = #{doc_id}
	</select>
</mapper>
